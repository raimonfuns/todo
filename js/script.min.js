function Gtd(){this.init()}Gtd.prototype={init:function(){var a=this;this.wrap=document.getElementById("wrap"),this.oTaskCategoryUl=this.wrap.getElementsByTagName("ul")[2],this.oContentMode=this.getByClass(this.wrap,"task-cont")[0],this.totalCount=this.getByClass(this.wrap,"taskCount")[0],this.sDefaultId="/10000",this.initLocalStorage(),this.updateCategory(this.sDefaultId),this.aTaskCategory=this.oTaskCategoryUl.getElementsByTagName("li"),this.aListItem=this.oTaskCategoryUl.getElementsByTagName("a"),this.oTargetAddOn=this.getByClass(this.oTaskCategoryUl,"on")[0],this.aDeleteBtn=this.oTaskCategoryUl.getElementsByTagName("i"),this.oAddCategoryBtn=document.getElementById("addCategory"),this.oAddTaskBtn=document.getElementById("addTask"),this.oProcess=document.getElementById("process"),this.oProcessUl=this.oProcess.getElementsByTagName("ul")[0],this.aProcessFilterBtn=this.oProcessUl.getElementsByTagName("a"),this.sProcessNow=0,this.oProcessContList=this.getByClass(this.oProcess,"cont-list")[0],this.sTaskOnId="/0",this.updateProcessList(this.sDefaultId),this.oTitleInput=this.oContentMode.getElementsByTagName("input")[0],this.oDateInput=this.oContentMode.getElementsByTagName("input")[1],this.oContentTextarea=this.oContentMode.getElementsByTagName("textarea")[0],this.oTaskContentBtn=this.getByClass(this.oContentMode,"btn-wrap")[0],this.oEditBtn=this.getByClass(this.oTaskContentBtn,"edit-btn")[0],this.oFinishBtn=this.getByClass(this.oTaskContentBtn,"finish-btn")[0],this.oOverlayCode=document.getElementById("overlayCode"),this.oPromptBoxWrap=document.getElementById("prompt-box-wrap"),this.oPromptBoxInput=this.oPromptBoxWrap.getElementsByTagName("input")[0],this.oPromptBoxText=this.getByClass(this.oPromptBoxWrap,"boxText")[0],this.oPromptSubmitBtn=this.getByClass(this.oPromptBoxWrap,"boxSubmit")[0],this.oConfirmBoxWrap=document.getElementById("confirm-box-wrap"),this.oConfirmBoxText=this.getByClass(this.oConfirmBoxWrap,"boxText")[0],this.oConfirmBoxBtnSure=this.getByClass(this.oConfirmBoxWrap,"boxBtnSure")[0],this.oConfirmBoxBtnCancel=this.getByClass(this.oConfirmBoxWrap,"boxBtnCancel")[0],this.oError=document.getElementById("error"),this.taskTrigger(),this.filterTaskState(),this.oAddCategoryBtn.onclick=function(){a.oPromptBoxInput.value="",a.oPromptBoxText.innerHTML="请输入目录名称:",a.showBox(a.oPromptBoxWrap),a.oPromptBoxInput.focus(),a.oPromptSubmitBtn.onclick=function(){a.addCategory.call(a),a.hideBox(a.oPromptBoxWrap)}},this.oPromptBoxInput.onkeydown=function(b){var c=b||event;13===c.keyCode&&a.oPromptSubmitBtn.onclick()},this.oAddTaskBtn.onclick=function(){a.addTask.call(a)},this.oEditBtn.onclick=function(){a.editTask.call(a)},this.oFinishBtn.onclick=function(){a.finishTask.call(a)},this.oOverlayCode.onclick=function(){a.oPromptBoxInput.value="",a.hideBox(a.oPromptBoxWrap),a.hideBox(a.oConfirmBoxWrap)}},initLocalStorage:function(){window.localStorage&&window.localStorage.getItem?this.ls=localStorage:alert("该浏览器不支持localStorage本地存储")},updateCategory:function(a){this.getItem(this.sDefaultId)||(this.setItem(this.sDefaultId,{total:0,rows:[]}),this.setItem("categoryStructor",{rows:[{id:"/10000",title:"默认分类",subcategory:null}]}));var b=this.getItem("categoryStructor");if(!b)return!1;var c="",d=b.rows,e=0;this.each(d,function(b,d){var f=this.getItem(d.id),g=f?f.total:0,h=d.id===this.sDefaultId?"task-dft ":"",i=d.id===a?"on ":"";if(e+=g,c+='<li class="TaskCategory group '+h+'TaskCategory-fold" data-id="'+d.id+'"><a href="#" class="list-item '+i+'ico-task"><span>'+d.title+"</span><span> ("+g+') </span><i class="ico-delete"></i></a>',d.subcategory){c+="<ul>";for(var j=0;j<d.subcategory.length;j++)f=this.getItem(d.subcategory[j].id),g=f?f.total:0,c+='<li class="TaskCategory group" data-id="'+d.subcategory[j].id+'"><a href="#" class="list-item ico-task-sec"><span>'+d.subcategory[j].title+"</span><span> ("+g+') </span><i class="ico-delete"></i></a></li>';c+="</ul></li>"}else c+="<ul></ul></li>"}),this.totalCount.innerHTML=e,this.oTaskCategoryUl.innerHTML=c,this.oTargetAddOn=this.getByClass(this.oTaskCategoryUl,"on")[0]},updateProcessList:function(a){var b=this,c={rows:[]},d=this.getItem(a),e=this.getItem("taskList"),f={},g="",h=["all","unfinished","finished"],i=h[this.sProcessNow]||"all";if(!d)return this.addTask(),this.oProcessContList.innerHTML="",!1;if(this.each(d.rows,function(a,b){this.each(e.rows,function(a,d){d.taskId===b&&c.rows.push(d)})}),c)for(var j=0;j<c.rows.length;j++){var k={};if("all"===i||"unfinished"===i&&!c.rows[j].finished||"finished"===i&&c.rows[j].finished)if(g=c.rows[j].taskTime,k.taskTitle=c.rows[j].taskTitle,k.taskId=c.rows[j].taskId,k.finished=c.rows[j].finished,f[g])f[g].push(k);else{var l=[];l.push(k),f[g]=l}}var m=[];for(var n in f)m.push(n);m.sort(),this.oProcessContList.innerHTML="",this.each(m,function(a,b){var c=document.createElement("h3"),d="",e="";c.className="taskTime",c.innerText=b,this.oProcessContList.appendChild(c),this.each(f[b],function(b,c){0===b&&0===a?(this.sTaskOnId=c.taskId,this.updateTaskInfo(this.sTaskOnId),e=" on"):e="",d=c.finished?"finished":"";var f=document.createElement("li"),g=document.createElement("a");f.className="noteTitle"+e+" "+d,f.setAttribute("task-id",c.taskId),g.href="javascript:void(0);",g.innerText=c.taskTitle,f.appendChild(g),this.oProcessContList.appendChild(f)})});var o=this.getByClass(this.oProcessContList,"noteTitle");this.each(o,function(a,c){c.onclick=function(){b.each(o,function(a,c){b.removeClass(c,"on")}),b.addClass(this,"on"),b.sTaskOnId!==this.getAttribute("task-id")&&(b.sTaskOnId=this.getAttribute("task-id"),b.updateTaskInfo(b.sTaskOnId))}})},updateTaskInfo:function(a){var b,c=this.oTargetAddOn.parentNode.getAttribute("data-id"),d={rows:[]},e=this.getItem(c),f=this.getItem("taskList");e&&this.each(e.rows,function(a,b){this.each(f.rows,function(a,c){c.taskId===b&&d.rows.push(c)})});var g=this.getByClass(this.oContentMode,"task-title-text")[0],h=this.getByClass(this.oContentMode,"task-date-text")[0],i=this.getByClass(this.oContentMode,"main-content")[0];this.oTitleInput=this.oContentMode.getElementsByTagName("input")[0],this.oDateInput=this.oContentMode.getElementsByTagName("input")[1],this.oContentTextarea=this.oContentMode.getElementsByTagName("textarea")[0],this.each(d.rows,function(c,d){d.taskId===a&&(b=d)}),b?(this.removeClass(this.oContentMode,"edit-mode"),g.innerText=b.taskTitle,h.innerText=b.taskTime,i.innerText=b.taskContent,this.oTitleInput.value=b.taskTitle,this.oDateInput.value=b.taskTime,this.oContentTextarea.value=b.taskContent):this.addTask()},taskTrigger:function(){var a=this;this.each(this.aListItem,function(a,b){}),this.oTaskCategoryUl.onclick=function(b){var c=b||event,d=c.target||c.srcElement,e=d.tagName.toLowerCase(),f=null;if("a"===e)a.oTargetAddOn=d,f=d.parentNode;else if("span"===e)a.oTargetAddOn=d.parentNode,f=d.parentNode.parentNode;else if("i"===e)return a.hasClass(d.parentNode.parentNode,"task-dft")?alert("默认分类不能删除"):(a.oConfirmBoxText.innerHTML="你确定删除《"+d.parentNode.children[0].innerHTML+"》分类吗?",a.showBox(a.oConfirmBoxWrap),a.oConfirmBoxBtnSure.onclick=function(){a.deleteCategory(d)},a.oConfirmBoxBtnCancel.onclick=function(){a.hideBox(a.oConfirmBoxWrap)}),!1;if(a.hasClass(f,"TaskCategory-fold")?a.removeClass(f,"TaskCategory-fold"):a.addClass(f,"TaskCategory-fold"),!a.hasClass(a.oTargetAddOn,"on")){a.each(a.aListItem,function(b,c){a.removeClass(c,"on")}),a.addClass(a.oTargetAddOn,"on");var g=a.aProcessFilterBtn;a.each(g,function(a,b){b.className=""}),g[0].className="active",a.removeClass(f,"TaskCategory-fold"),a.sProcessNow=0,a.updateProcessList.call(a,a.oTargetAddOn.parentNode.getAttribute("data-id"))}}},deleteCategory:function(a){var b=this.getItem("categoryStructor"),c=this.getItem("taskList"),d=a.parentNode.parentNode.getAttribute("data-id"),e=this.getItem(d)?this.getItem(d):{rows:[]};if(this.hasClass(a.parentNode,"ico-task-sec")){var f=a.parentNode.parentNode.parentNode.parentNode.getAttribute("data-id"),g=this.getItem(f);this.each(e.rows,function(a,b){this.each(c.rows,function(a,d){d.taskId===b&&(g.total--,c.rows.splice(a,1))})}),this.ls[d]=void 0;try{delete this.ls[d]}catch(h){}this.each(b.rows,function(a,b){b.id===f&&this.each(b.subcategory,function(a,c){c.id===d&&b.subcategory.splice(a,1)})}),this.setItem("categoryStructor",b),this.setItem("taskList",c),this.setItem(f,g),this.updateCategory(f),this.updateProcessList(f)}else{this.each(e.rows,function(a,b){this.each(c.rows,function(a,d){d.taskId===b&&c.rows.splice(a,1)})}),this.each(b.rows,function(a,b){if(b.id===d){var c=b.subcategory;c&&this.each(c,function(a,b){this.ls[b.id]=void 0,this.ls[b.id]=void 0;try{delete this.ls[b.id]}catch(c){}})}}),this.ls[d]=void 0;try{delete this.ls[d]}catch(h){}this.each(b.rows,function(a,c){c.id===d&&b.rows.splice(a,1)}),this.setItem("categoryStructor",b),this.setItem("taskList",c),this.updateCategory(this.sDefaultId),this.updateProcessList(this.sDefaultId)}this.updateTaskInfo(this.sTaskOnId),this.hideBox(this.oConfirmBoxWrap)},filterTaskState:function(){var a=this,b=this.aProcessFilterBtn;this.each(b,function(c,d){d.index=c,d.onclick=function(){this.index!==a.sProcessNow&&(a.each(b,function(a,b){b.className=""}),a.sProcessNow=this.index,this.className="active",a.updateProcessList(a.oTargetAddOn.parentNode.getAttribute("data-id")))}})},addCategory:function(){var a=this,b=a.oPromptBoxInput.value;if(!b)return!1;for(var c=document.createElement("li"),d={},e=this.getItem("categoryStructor"),f="/"+parseInt(1e6*Math.random());a.ls[f];)f="/"+parseInt(1e6*Math.random());if(d={id:f,title:b,subcategory:null},c.className="TaskCategory",c.setAttribute("data-id",f),this.hasClass(this.oTargetAddOn.parentNode,"task-dft"))c.innerHTML='<a href="#" class="list-item ico-task"><span>'+b+'</span><span> (0)</span><i class="ico-delete"></i></a><ul></ul>',this.oTaskCategoryUl.appendChild(c),e.rows.push(d);else{var g="";c.innerHTML='<a href="#" class="list-item ico-task-sec"><span>'+b+'</span><span> (0)</span><i class="ico-delete"></i></a>',this.hasClass(this.oTargetAddOn,"ico-task-sec")?(g=this.oTargetAddOn.parentNode.parentNode.parentNode.getAttribute("data-id"),this.oTargetAddOn.parentNode.parentNode.appendChild(c)):(g=this.oTargetAddOn.parentNode.getAttribute("data-id"),this.removeClass(this.oTargetAddOn.parentNode,"TaskCategory-fold"),this.oTargetAddOn.nextElementSibling?this.oTargetAddOn.nextElementSibling.appendChild(c):this.oTargetAddOn.nextSibling.appendChild(c)),this.each(e.rows,function(a,c){if(c.id===g){var d={id:f,title:b};aOldSubcategoryData=c.subcategory||[],aOldSubcategoryData.push(d),c.subcategory=aOldSubcategoryData}})}this.setItem("categoryStructor",e)},addTask:function(){var a=this,b=this.getByClass(a.oContentMode,"if-save-btn")[0],c=this.getByClass(a.oContentMode,"if-save-btn")[1];this.oTitleInput.value="",this.oDateInput.value="",this.oContentTextarea.value="",this.btnTrigger.call(this),this.addClass(a.oContentMode,"edit-mode"),b.onclick=function(){a.saveTask()},c.onclick=function(){a.btnTrigger.call(a),a.removeClass(a.oContentMode,"edit-mode")}},editTask:function(){var a=this,b=this.getByClass(this.oContentMode,"if-save-btn")[0],c=this.getByClass(this.oContentMode,"if-save-btn")[1];this.btnTrigger.call(this),this.addClass(this.oContentMode,"edit-mode"),b.onclick=function(){a.saveEditTask()},c.onclick=function(){a.btnTrigger.call(a),a.updateTaskInfo(a.sTaskOnId),a.removeClass(a.oContentMode,"edit-mode")}},saveTask:function(){this.btnTrigger(),this.getItem("taskList")||this.setItem("taskList",{rows:[]});var a=this.oTargetAddOn.parentNode.getAttribute("data-id"),b=this.getItem(a)?this.getItem(a):{total:0,rows:[]},c={},d=this.getItem("taskList"),e="/"+parseInt(1e6*Math.random()),f=[];for(this.each(d.rows,function(a,b){f.push(b.taskId)});f[e];)e="/"+parseInt(1e6*Math.random());if(b.total++,c.taskId=e,c.taskTitle=this.oTitleInput.value,c.taskTime=this.oDateInput.value,c.taskContent=this.oContentTextarea.value,c.finished=!1,!this.checkValid(c.taskTitle,c.taskTime))return!1;if(b.rows.push(c.taskId),d.rows.push(c),this.setItem("taskList",d),this.hasClass(this.oTargetAddOn,"ico-task-sec")){var g=this.oTargetAddOn.parentNode.parentNode.parentNode.getAttribute("data-id"),h=this.getItem(g)?this.getItem(g):{total:0,rows:[]},i=this.oTargetAddOn.parentNode.parentNode.previousSibling?this.oTargetAddOn.parentNode.parentNode.previousSibling:this.oTargetAddOn.parentNode.parentNode.previousElementSibling;h.total++,i.children[1].innerHTML=" ("+h.total+") ",h.rows.push(c.taskId),this.setItem(g,h)}this.setItem(a,b),this.oTargetAddOn.children[1].innerHTML=" ("+b.total+") ",this.totalCount.innerHTML=1+parseInt(this.totalCount.innerHTML),this.updateProcessList(a),this.removeClass(this.oContentMode,"edit-mode")},saveEditTask:function(){this.btnTrigger();var a=this.oTargetAddOn.parentNode.getAttribute("data-id"),b={},c=this.getItem("taskList");return b.taskId=this.sTaskOnId,b.taskTitle=this.oTitleInput.value,b.taskTime=this.oDateInput.value,b.taskContent=this.oContentTextarea.value,this.checkValid(b.taskTitle,b.taskTime)?(this.each(c.rows,function(a,d){d.taskId===this.sTaskOnId&&(b.finished=d.finished,c.rows[a]=b)}),this.setItem("taskList",c),this.updateProcessList(a),void this.removeClass(this.oContentMode,"edit-mode")):!1},checkValid:function(a,b){if(0==a.length)this.oError.innerText="请输入标题",this.css(this.oError,"display","inline-block");else{if(/\d{4}-\d{2}-\d{2}/.test(b))return this.css(this.oError,"display","none"),!0;this.oError.innerText="请输入正确的日期格式，如2015-01-01",this.css(this.oError,"display","inline-block")}return!1},finishTask:function(){var a=this;a.oConfirmBoxText.innerHTML="是否确认完成？",a.showBox(a.oConfirmBoxWrap),a.oConfirmBoxBtnSure.onclick=function(){var b=a.getItem("taskList");a.each(b.rows,function(b,c){c.taskId===a.sTaskOnId&&(c.finished=!0)}),a.setItem("taskList",b),a.aProcessFilterBtn[2].onclick(),a.hideBox(a.oConfirmBoxWrap)},a.oConfirmBoxBtnCancel.onclick=function(){a.hideBox(a.oConfirmBoxWrap)}},btnTrigger:function(){this.css(this.oTaskContentBtn,"right","-85"),this.doMove(this.oTaskContentBtn,{right:0},null,5)},showBox:function(a){this.css(a,"top",document.documentElement.clientHeight/2-100),this.css(a,"display","block"),this.css(this.oOverlayCode,"opacity",0),this.css(this.oOverlayCode,"display","block"),this.doMove(this.oOverlayCode,{opacity:80},null,2)},hideBox:function(a){a.style.display="none",this.oOverlayCode.style.display="none"},css:function(a,b,c){if(2===arguments.length)return a.currentStyle?a.currentStyle[b]:getComputedStyle(a,!1)[b];if(3===arguments.length)switch(b){case"width":case"height":case"top":case"left":case"right":case"bottom":a.style[b]=c+"px";break;case"opacity":a.style.filter="alpha(opcity:"+c+")",a.style.opacity=c/100;break;default:a.style[b]=c}},doMove:function(a,b,c,d){var e=this;clearInterval(a.timer),a.timer=setInterval(function(){var f=!0;for(var g in b){var h=parseFloat(e.css(a,g));"opacity"===g&&(h=parseInt(100*h.toFixed(2)));var i=(b[g]-h)/d;i=i>0?Math.ceil(i):Math.floor(i),h!=b[g]&&(f=!1,e.css(a,g,h+i))}f&&(clearInterval(a.timer),c&&c.apply(this,arguments))},30)},getItem:function(a){return JSON.parse(this.ls.getItem(a))},setItem:function(a,b){this.ls.setItem(a,JSON.stringify(b))},getByClass:function(a,b){for(var c=a.getElementsByTagName("*"),d=[],e=0;e<c.length;e++)this.hasClass(c[e],b)&&d.push(c[e]);return d},trim:function(a){return a.replace(/^\s+|\s+$/g,"")},getClassNames:function(a){return a?this.trim(a.className).replace(/\s+/g," ").split(" "):!1},addClass:function(a,b){if(!a||!b)return!1;var c=this.getClassNames(a);return-1!=this.inArray(b,c)?!1:void(a.className+=(a.className?" ":"")+b)},removeClass:function(a,b){if(!a||!b)return!1;for(var c=this.getClassNames(a),d=c.length,e=0;d>e;e++)c[e]===b&&c.splice(e,1);return a.className=c.join(" "),d===c.length?!1:!0},inArray:function(a,b){return Array.prototype.indexOf||(Array.prototype.indexOf=function(a){var b=this.length>>>0,c=Number(arguments[1])||0;for(c=0>c?Math.ceil(c):Math.floor(c),0>c&&(c+=b);b>c;c++)if(c in this&&this[c]===a)return c;return-1}),b.indexOf(a,arguments[2])},hasClass:function(a,b){var c=this.getClassNames(a);return-1!=this.inArray(b,c)},isArray:function(a){var b=Object.prototype.toString.call(a).slice(8,-1).toLowerCase();return"array"==b?!0:!1},each:function(a,b){if("function"!=typeof b)return!1;for(var c=0;c<a.length;c++)b.call(this,c,a[c])}},window.onload=function(){new Gtd};